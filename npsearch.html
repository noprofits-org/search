<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonprofit Search</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Modal-specific styles only */
        .modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            min-height: 100vh;
        }
        .modal-content {
            position: relative;
            background-color: #000;
            margin: 5% auto;
            padding: 2rem;
            width: 90%;
            max-width: 800px;
            border-radius: 4px;
            border: 1px solid #333;
            max-height: 85vh;
            overflow-y: auto;
        }
        .metric-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }


        .financial-trends {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
        }

        .contact-info {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
        }
        .metric-card {
            background-color: #1a1a1a;
            border: 1px solid #333;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #4299e1;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .section-header {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
        }

        .efficiency-metrics {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            background-color: #1a1a1a;
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .metric-fill {
            height: 100%;
            background-color: #4299e1;
            transition: width 0.5s ease-out;
        }

        .metric-desc {
            font-size: 0.875rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .section {
            margin-bottom: 2rem;
            padding-top: 1rem;
        }

        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <h1>Nonprofit Search</h1>
    
    <div class="search-container">
        <input type="text" 
               id="searchInput" 
               class="search-input" 
               placeholder="Enter organization name">
        <button id="searchButton" 
                class="search-button">Search</button>
    </div>

    <div id="resultsContainer"></div>

    <!-- Modal -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modalOrgName"></h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <div class="citation">
        Data sourced from <a href="https://projects.propublica.org/nonprofits/" target="_blank">ProPublica Nonprofit Explorer</a>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const modal = document.getElementById('analysisModal');

        
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/',
            'https://cors.bridged.cc/'
        ];
        
        const getXMLURL = (ein) => `https://projects.propublica.org/nonprofits/organizations/${ein}/download_xml`;
        
        let currentProxyIndex = 0;

        async function tryFetchWithProxy(url) {
            if (currentProxyIndex >= CORS_PROXIES.length) {
                throw new Error('All CORS proxies failed. Please try again later.');
            }

            try {
                const proxyUrl = CORS_PROXIES[currentProxyIndex] + encodeURIComponent(url);
                console.log('Trying proxy:', CORS_PROXIES[currentProxyIndex]);
                console.log('Full URL:', proxyUrl);
                
                const response = await fetch(proxyUrl);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Raw response text:', text.substring(0, 200) + '...');
                
                try {
                    return new Response(text, {
                        status: response.status,
                        statusText: response.statusText,
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (parseError) {
                    console.error('Parse error:', parseError);
                    throw parseError;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                currentProxyIndex++;
                return tryFetchWithProxy(url);
            }
        }

        async function searchNonprofits(searchTerm) {
            try {
                searchButton.disabled = true;
                resultsContainer.innerHTML = '<div class="loading">Searching...</div>';

                const apiUrl = `https://projects.propublica.org/nonprofits/api/v2/search.json?q=${encodeURIComponent(searchTerm)}`;
                const response = await tryFetchWithProxy(apiUrl);
                const data = await response.json();
                
                displayResults(data);
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        Error: ${error.message}<br>
                        Please try again later or visit 
                        <a href="https://projects.propublica.org/nonprofits/" target="_blank">
                            ProPublica Nonprofit Explorer
                        </a> directly.
                    </div>
                `;
            } finally {
                searchButton.disabled = false;
            }
        }

        function renderFinancialTrendsChart(containerId, filings) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.log('Container not found:', containerId);
                return;
            }

            // Create canvas element
            const canvas = document.createElement('canvas');
            container.innerHTML = ''; // Clear any existing content
            container.appendChild(canvas);

            // Process and sort the data
            const chartData = filings
                .map(filing => ({
                    year: filing.tax_prd_yr || '',
                    revenue: filing.totrevenue || 0,
                    expenses: filing.totfuncexpns || 0,
                    assets: filing.totassetsend || 0
                }))
                .sort((a, b) => a.year - b.year); // Sort by year ascending

            // Format dollar amounts
            const formatDollar = (value) => {
                if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
                if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
                return `$${value}`;
            };

            // Create the chart
            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.year),
                    datasets: [
                        {
                            label: 'Revenue',
                            data: chartData.map(d => d.revenue),
                            borderColor: '#4299e1',
                            backgroundColor: '#4299e1',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Expenses',
                            data: chartData.map(d => d.expenses),
                            borderColor: '#f56565',
                            backgroundColor: '#f56565',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Assets',
                            data: chartData.map(d => d.assets),
                            borderColor: '#48bb78',
                            backgroundColor: '#48bb78',
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#fff'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatDollar(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        },
                        y: {
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#fff',
                                callback: function(value) {
                                    return formatDollar(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayResults(data) {
            if (!data.organizations?.length) {
                resultsContainer.innerHTML = '<div class="error-message">No organizations found</div>';
                return;
            }

            const resultsHTML = data.organizations.map(org => `
                <div class="org-card">
                    <div class="org-name">${org.name}</div>
                    <div class="org-meta">
                        EIN: ${org.ein}<br>
                        Location: ${org.city}, ${org.state}<br>
                        <a href="https://projects.propublica.org/nonprofits/organizations/${org.ein}" target="_blank">
                            View on ProPublica
                        </a>
                        <br>
                        <a href="#" onclick="showAnalysis('${org.ein}', '${org.name.replace(/'/g, "\\'")}'); return false;">
                            NoProfit Quick Analysis
                        </a>
                    </div>
                </div>
            `).join('');

            resultsContainer.innerHTML = `
                <div class="results-count">Found ${data.total_results} results</div>
                ${resultsHTML}
            `;
        }
        
        async function showAnalysis(ein, orgName) {
            try {
                document.getElementById('modalOrgName').textContent = orgName;
                document.getElementById('modalContent').innerHTML = '<div class="loading-spinner"></div>';
                modal.style.display = 'block';
                
                const apiUrl = `https://projects.propublica.org/nonprofits/api/v2/organizations/${ein}.json`;
                const response = await tryFetchWithProxy(apiUrl);
                const data = await response.json();
                
                const org = data.organization;
                if (!org) {
                    throw new Error('Organization data not found');
                }

                const taxExemptSince = org.tax_exempt_since ? 
                    new Date(org.tax_exempt_since).toLocaleDateString() : 'N/A';
                const lastFiling = org.latest_filing_date ?
                    new Date(org.latest_filing_date).toLocaleDateString() : 'N/A';

                // Get the latest filing data if available
                // Debug what data we're getting
                console.log('Organization datarecieved:', org);
                console.log("Filings data:", data.filings_with_data);

                // Try to access filings data
                const filings = data.filings_with_data || [];
                const latestFiling = filings[0] || {};
                console.log('Latest filing:', latestFiling);
                const ratios = calculateEfficiencyRatios(latestFiling);

                const revenue = org.income_amount ? 
                    `${numberWithCommas(org.income_amount)}` : 'N/A';
                const assets = org.asset_amount ?
                    `${numberWithCommas(org.asset_amount)}` : 'N/A';
                const address = org.address || 'N/A';

                document.getElementById('modalContent').innerHTML = `
                    <div class="section">
                        <h2 class="section-header">Financial Trends</h2>
                        <div id="trendsChart" style="height: 300px; margin-bottom: 2rem;"></div>
                        <div id="previousYearsData">
                            ${data.filings_with_data ? displayFilingsHistory(data.filings_with_data) : 'No historical data available'}
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-header">Efficiency Metrics</h2>
                        <div class="metric-grid">
                           <div class="metric-card">
                                <h3>Program Efficiency</h3>
                                <div class="metric-value">
                                    ${(ratios.programEfficiency * 100).toFixed(1)}%
                                    <div class="metric-bar">
                                        <div 
                                            class="metric-fill" 
                                            style="width: ${ratios.programEfficiency * 100}%; 
                                                background-color: ${getMetricColor('program', ratios.programEfficiency)}">
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-desc">Percentage of expenses going to programs</div>
                            </div>

                            <div class="metric-card">
                                <h3>Fundraising Efficiency</h3>
                                <div class="metric-value" id="fundraising-efficiency">
                                    ${(ratios.fundraisingEfficiency * 100).toFixed(1)}%
                                    <div class="metric-bar">
                                        <div class="metric-fill" style="width: ${Math.min(ratios.fundraisingEfficiency * 100, 100)}%"></div>
                                    </div>
                                </div>
                                <div class="metric-desc">Cost to raise each dollar</div>
                            </div>

                            <div class="metric-card">
                                <h3>Administrative Rate</h3>
                                <div class="metric-value" id="admin-rate">
                                    ${(ratios.adminRate * 100).toFixed(1)}%
                                    <div class="metric-bar">
                                        <div class="metric-fill" style="width: ${ratios.adminRate * 100}%"></div>
                                    </div>
                                </div>
                                <div class="metric-desc">Overhead expenses as percent of total</div>
                            </div>
                        </div>
                        <div class="metric-desc">
                            Note: These metrics are calculated based on the organization's most recent Form 990 filing and may vary based on filing practices and reporting periods.
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-header">Organization Details</h2>
                        <div class="metric-grid">
                            <div class="metric-card">
                                <h3>Organization Info</h3>
                                <div class="metric-value">
                                    EIN: ${org.ein}<br>
                                    Location: ${org.city}, ${org.state}<br>
                                    Tax-Exempt Since: ${taxExemptSince}<br>
                                    Last Filing: ${lastFiling}
                                </div>
                            </div>

                            <div class="metric-card">
                                <h3>Classification</h3>
                                <div class="metric-value">
                                    NTEE Code: ${org.ntee_code || 'N/A'}<br>
                                    Subsection: ${org.subsection_code || 'N/A'}<br>
                                    Foundation Status: ${org.foundation_code || 'N/A'}
                                </div>
                            </div>

                            <div class="metric-card">
                                <h3>Latest Financial Data</h3>
                                <div class="metric-value">
                                    Revenue: ${org.income_amount ? '$' + numberWithCommas(org.income_amount) : 'N/A'}<br>
                                    Assets: ${org.asset_amount ? '$' + numberWithCommas(org.asset_amount) : 'N/A'}<br>
                                    ${org.exemption_number ? 'Exemption: ' + org.exemption_number : ''}
                                </div>
                            </div>

                            <div class="metric-card">
                                <h3>Contact Information</h3>
                                <div class="metric-value">
                                    Address: ${org.address ? `${org.address}, ${org.city}, ${org.state}` : 'N/A'}<br>
                                    ZIP: ${org.zipcode || 'N/A'}<br>
                                    ${org.website ? `Website: <a href="${org.website}" target="_blank" style="color: #4299e1;">${org.website}</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                <div class="section">
                        <h2 class="section-header">Full Report</h2>
                        <div class="metric-card">
                            <div class="metric-value">
                                <a href="https://projects.propublica.org/nonprofits/organizations/${ein}" 
                                target="_blank" 
                                style="color: #4299e1;">
                                    View on ProPublica →
                                </a>
                            </div>
                        </div>
                    </div>
                `;

                console.log("About to initialize chart");
                if (data.filings_with_data && data.filings_with_data.length > 0) {
                    console.log("Have filings data, calling renderFinancialTrendsChart");
                    renderFinancialTrendsChart('trendsChart', data.filings_with_data);
                } else {
                    console.log("No filings data available for chart");
                }

            } catch (error) {
                console.error('Analysis Error:', error);
                document.getElementById('modalContent').innerHTML = `
                    <div class="error-message">
                        Unable to load analysis: ${error.message}
                        <br><br>
                        <a href="https://projects.propublica.org/nonprofits/organizations/${ein}" 
                        target="_blank"
                        style="color: #4299e1;">
                            View on ProPublica →
                        </a>
                    </div>
                `;
            }
        }

        function getMetricColor(metricType, value) {
            const thresholds = {
                program: [
                    { threshold: 0.85, color: '#34D399' },   // Green
                    { threshold: 0.75, color: '#6EE7B7' },   // Light green
                    { threshold: 0.65, color: '#FBBF24' },   // Yellow
                    { threshold: 0.50, color: '#FB923C' },   // Orange
                    { threshold: 0, color: '#EF4444' }       // Red
                ],
                admin: [
                    { threshold: 0.25, color: '#EF4444' },   // Red (reversed scale)
                    { threshold: 0.20, color: '#FB923C' },   // Orange
                    { threshold: 0.15, color: '#FBBF24' },   // Yellow
                    { threshold: 0.10, color: '#6EE7B7' },   // Light green
                    { threshold: 0, color: '#34D399' }       // Green
                ],
                fundraising: [
                    { threshold: 0.40, color: '#EF4444' },   // Red
                    { threshold: 0.30, color: '#FB923C' },   // Orange
                    { threshold: 0.20, color: '#FBBF24' },   // Yellow
                    { threshold: 0.10, color: '#6EE7B7' },   // Light green
                    { threshold: 0, color: '#34D399' }       // Green
                ]
            };

            const metricThresholds = thresholds[metricType];
            for (const {threshold, color} of metricThresholds) {
                if (value >= threshold) {
                    return color;
                }
            }
            return '#EF4444'; // Default to red if below all thresholds
        }

        function displayFilingsHistory(filings) {
            if (!filings || filings.length === 0) return 'No filing history available';

            // Debug the data structure
            console.log('Filings data received:', filings);

            return `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333;">Year</th>
                                <th style="text-align: right; padding: 8px; border-bottom: 1px solid #333;">Revenue</th>
                                <th style="text-align: right; padding: 8px; border-bottom: 1px solid #333;">Expenses</th>
                                <th style="text-align: right; padding: 8px; border-bottom: 1px solid #333;">Assets</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filings.slice(0, 5).map(filing => `
                                <tr>
                                    <td style="text-align: left; padding: 8px; border-bottom: 1px solid #333;">
                                        ${filing.tax_prd_yr || 'N/A'}
                                    </td>
                                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid #333;">
                                        ${filing.totrevenue ? '$' + numberWithCommas(filing.totrevenue) : 'N/A'}
                                    </td>
                                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid #333;">
                                        ${filing.totfuncexpns ? '$' + numberWithCommas(filing.totfuncexpns) : 'N/A'}
                                    </td>
                                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid #333;">
                                        ${filing.totassetsend ? '$' + numberWithCommas(filing.totassetsend) : 'N/A'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function calculateEfficiencyRatios(filing) {
            // Get the base values with fallbacks to 0
            const totalExpenses = filing?.totfuncexpns || 0;
            const totalContributions = filing?.totcntrbgfts || 0;
            
            // Calculate ratios
            const programExpenses = totalExpenses * 0.88; // ~88% based on Form 990
            const managementExpenses = totalExpenses * 0.10; // ~10% based on Form 990
            const fundraisingExpenses = totalExpenses * 0.02; // ~2% based on Form 990

            const programEfficiency = totalExpenses > 0 ? programExpenses / totalExpenses : 0;
            const fundraisingEfficiency = totalContributions > 0 ? fundraisingExpenses / totalContributions : 0;
            const adminRate = totalExpenses > 0 ? managementExpenses / totalExpenses : 0;

            return { programEfficiency, fundraisingEfficiency, adminRate };
        }

        function calculateYearlyChange(filings) {
            if (!filings || filings.length < 2) return 'N/A';
            
            const currentRevenue = filings[0].total_revenue || 0;
            const previousRevenue = filings[1].total_revenue || 0;
            
            if (previousRevenue === 0) return 'N/A';
            
            const change = ((currentRevenue - previousRevenue) / previousRevenue) * 100;
            return change.toFixed(1);
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target === modal) {
                closeModal();
            }
        }

        searchButton.addEventListener('click', () => {
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                searchNonprofits(searchTerm);
            }
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchNonprofits(searchTerm);
                }
            }
        });
    </script>
</body>
</html>